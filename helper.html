<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#14b8a6">
<link rel="icon" href="ikon-512.png">
<title>Form Pesanan - Famili Helper</title>

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script type="text/javascript">
   (function(){
      emailjs.init("pwh80buTjccp3P0MD"); // Ganti YOUR_USER_ID dengan user ID dari EmailJS
   })();
</script>
<style>

*{
  box-sizing:border-box;
  font-family:'Nunito',sans-serif;
  user-select:none;
  -webkit-user-select:none;
  outline:none;
}
body{
  margin:0;
  min-height:100vh;
  background:var(--bg);
  color:var(--text);
  transition:.35s ease;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:16px;
  padding-bottom: 120px;
  -webkit-tap-highlight-color:transparent;
}
:root{
  --primary:#14b8a6;         /* Biru kehijauan */
  --primary-soft:rgba(20,184,166,.15);
  --bg:#e0fdfa;              /* Latar belakang halaman */
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --danger:#ef4444;
  --border:#d1fae5;
  --radius:18px;
  --blur:10px;
  --glow:none;
  --teks:orange;
}

body.theme-dark{
  --bg:#0a1f1b;
  --card:#0f172a;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --primary:#2dd4bf;
  --primary-soft:#134e4a;
  --border:#134e4a;
}

body.theme-future{
  --bg:radial-gradient(circle at top,#0a1f1b,#020617);
  --card:rgba(15,23,42,.65);
  --text:#e0f2fe;
  --muted:#7dd3fc;
  --primary:#2dd4bf;
  --primary-soft:rgba(45,212,191,.15);
  --danger:#fb7185;
  --border:rgba(45,212,191,.35);
  --glow:
    0 0 12px rgba(45,212,191,.35),
    0 0 26px rgba(45,212,191,.2);
  --teks:#d65000f6;
}

.card{
  width:100%;
  max-width:480px;
  background:var(--card);
  border-radius:var(--radius);
  padding:24px;
  border:1px solid var(--border);
  box-shadow:0 14px 36px rgba(0,0,0,.15),var(--glow);
animation:fadeUp .6s ease;
}
@keyframes fadeUp{
  from{opacity:0;transform:translateY(18px)}
  to{opacity:1}
}
h2{text-align:center;margin-bottom:20px;font-weight:900}

/* INFO KECIL USER */
.user-info{
  font-size:15px;
  color:var(--muted);
  margin-bottom:16px;
  line-height:1.4;
}

/* ===== MODERN CUSTOM DROPDOWN ===== */
.custom-select-wrapper{
  position:relative;
  margin:8px 0 16px;
}

.custom-select{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 16px;
  border-radius:18px;
  border:1px solid var(--border);
  background:linear-gradient(
    135deg,
    rgba(255,255,255,.6),
    rgba(255,255,255,.2)
  );
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
  color:var(--text);
  font-weight:700;
  cursor:pointer;
  transition:.25s ease;
}

body.theme-dark .custom-select,
body.theme-future .custom-select{
  background:linear-gradient(
    135deg,
    rgba(15,23,42,.7),
    rgba(15,23,42,.4)
  );
  box-shadow:0 14px 36px rgba(0,0,0,.15),var(--glow);
}

.custom-select:hover{
  border-color:var(--primary);
  box-shadow:0 0 0 2px rgba(37,99,235,.15);
}

.custom-select .arrow{
  font-size:12px;
  opacity:.6;
  transition:.25s ease;
}

/* rotate arrow saat open */
.custom-options.show + .custom-select .arrow{
  transform:rotate(180deg);
}

/* OPTIONS PANEL */
.custom-options{
  position:absolute;
  top:110%;
  left:0;
  width:100%;
  background:linear-gradient(
    135deg,
    rgba(255,255,255,.75),
    rgba(255,255,255,.4)
  );
  backdrop-filter:blur(14px);
  -webkit-backdrop-filter:blur(14px);
  border:1px solid var(--border);
  border-radius:20px;
  padding:6px;
  display:none;
  flex-direction:column;
  z-index:100;
  box-shadow:0 12px 32px rgba(0,0,0,.18);
  animation:fadeUp .25s ease;
}

body.theme-dark .custom-options,
body.theme-future .custom-options{
  background:linear-gradient(
    135deg,
    rgba(15,23,42,.85),
    rgba(15,23,42,.6)
  );
}

/* OPTION ITEM */
.custom-option{
  padding:12px 14px;
  border-radius:14px;
  cursor:pointer;
  font-weight:700;
  transition:.2s ease;
}

.custom-option:hover{
  background:rgba(37,99,235,.15);
  transform:translateX(2px);
}

/* animation */
@keyframes fadeUp{
  from{opacity:0;transform:translateY(6px)}
  to{opacity:1;transform:translateY(0)}
}

/* FORM INPUT */
label{font-size:13px;color:var(--muted);margin-top:8px;display:block}
input,textarea{
  width:100%;
  margin:6px 0 14px;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--text);
  box-shadow:0 14px 36px rgba(0,0,0,.15),var(--glow);
}
textarea{resize:none}
.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:16px;
  background:var(--primary);
  color:#fff;
  font-weight:800;
  cursor:pointer;
}
.btn:active{transform:scale(.97)}
.small{font-size:12px;color:var(--muted);text-align:center;margin-bottom:10px}

/* Toast Popup */
.toast {
  position: fixed;
  bottom: 300px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(37, 99, 235, 0.95);
  color: #fff;
  padding: 12px 20px;
  border-radius: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  font-weight: 700;
  font-size: 14px;
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: 0.3s ease;
}
.toast.show {
  opacity: 1;
  pointer-events: auto;
}

/*FAQ*/
.faq-section ul li {
  padding:10px 14px;
  margin-bottom:6px;
  background:var(--primary-soft);
  border-radius:12px;
  cursor:pointer;
  transition:.2s ease;
  font-weight:700;
  color:var(--text);
}
.faq-section ul li:hover {
  background:var(--primary);
  color:#fff;
}

/* POPUP MODAL */
.faq-popup {
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  background:var(--muted);
  padding:24px;
  border-radius:20px;
  box-shadow:0 12px 36px rgba(0,0,0,.25);
  max-width:320px;
  width:90%;
  z-index:9999;
  display:none;
  animation:fadeUp .3s ease;
}
.faq-popup h4 {
  margin-top:0;
  font-weight:800;
  font-size:16px;
  margin-bottom:12px;
  color: var(--teks);
}
.faq-popup p {
  font-size:15px;
  font-weight: 700;
  line-height:1.5;
  color:var(--card);
}
.faq-popup .close-btn {
  margin-top:16px;
  padding:8px 12px;
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
  width:100%;
}
.faq-overlay {
  position:fixed;
  top:0; left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,.35);
  z-index:9998;
  display:none;
}
/* ================= BOTTOM NAVBAR ================= */
.bottom-nav {
  position: fixed;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--card);
  display: flex;
  gap: 26px;
  padding: 12px 20px;
  border-radius: 28px;
  box-shadow: 0 10px 30px rgba(0,0,0,.15);
  border: 1px solid var(--border);
  backdrop-filter: blur(10px);
  z-index: 999;
}

.nav-item {
  text-align: center;
  font-size: 11px;
  font-weight: 700;
  color: var(--muted);
  cursor: pointer;
  transition: .2s;
}

.nav-item svg {
  width: 26px;
  height: 26px;
  background: var(--primary-soft);
  padding: 8px;
  border-radius: 50%;
  fill: var(--primary);
  margin-bottom: 4px;
}

.nav-item.active {
  color: var(--primary);
}

.nav-item.active svg {
  background: var(--primary);
  fill: white;
}
/* ===== POPUP KONFIRMASI PESANAN ===== */
#confirmOverlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  z-index:9998;
  backdrop-filter: blur(2px);
}

#confirmBox{
  display:none;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:var(--card);
  padding:20px;
  border-radius:18px;
  box-shadow:0 12px 40px rgba(0,0,0,.25);
  z-index:9999;
  width:90%;
  max-width:320px;
  text-align:center;
  border:1px solid var(--border);
  animation:fadeUp .2s ease;
}

#confirmBox h3{
  margin-top:0;
  font-weight:900;
}

#confirmBox p{
  font-size:14px;
  color:var(--muted);
}

.confirm-actions{
  display:flex;
  gap:10px;
  margin-top:16px;
}

.btn-cancel{
  flex:1;
  padding:10px;
  border-radius:12px;
  border:1px solid var(--border);
  background:transparent;
  font-weight:700;
  color:var(--text);
}

.btn-confirm{
  flex:1;
  padding:10px;
  border-radius:12px;
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:900;
}

.btn-cancel:active,
.btn-confirm:active{
  transform:scale(.97);
}
/*POPUP TUTUP*/
#closedOverlay {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.5);
  z-index: 99998;
  display:none;
}

#closedPopup {
  position: fixed;
  top:50%; left:50%;
  transform: translate(-50%,-50%);
  background: var(--muted);
  padding: 24px;
  border-radius: 20px;
  text-align: center;
  box-shadow: 0 12px 36px rgba(0,0,0,0.3);
  z-index: 99999;
  width: 280px;
  display:none;
  animation: fadeUp .3s ease;
}

#closedBtn:hover{
  opacity:0.9;
  transform:scale(1.02);
  transition:.2s ease;
}
</style>
</head>

<body>

<div class="card">
  <h2>Form Pesanan</h2>

  <div class="user-info">
    <div>Nama: <span id="nama"></span></div>
    <div>WhatsApp: <span id="whatsapp"></span></div>
    <div>Alamat: <span id="alamat"></span></div>
  </div>

  <!-- CUSTOM DROPDOWN -->
  <div class="custom-select-wrapper">
    <div class="custom-select" id="jenisLayananBtn">
      <span id="selectedOption" data-value="">-- Pilih Layanan --</span>
      <div class="arrow">â–¼</div>
    </div>
    <div class="custom-options" id="customOptions">
      <div class="custom-option" data-value="Titip Belanja">Titip Belanja</div>
      <div class="custom-option" data-value="Titip Makanan">Titip Makanan</div>
      <div class="custom-option" data-value="Antar Barang">Antar Barang</div>
      <div class="custom-option" data-value="Lainnya">Lainnya</div>
    </div>
  </div>

  <div id="dynamicInput"></div>

  <label>Catatan Tambahan</label>
  <textarea id="catatan" rows="2" placeholder="Jelaskan detail di sini"></textarea>

  <button class="btn" onclick="openConfirm()">Kirim Pesanan</button>
  <div class="small" id="status"></div>
    <div class="faq-section">
    <h3 style="margin-top:24px; font-weight:700;">Pertanyaan Umum (FAQ)</h3>
    <ul style="list-style:none; padding:0; margin:10px 0 0;">
      <li class="faq-item" data-text="Famili Helper adalah layanan personal yang membantu kebutuhan rumah tangga atau keluarga, misal titip belanja, titip makanan, atau antar barang.">1. Famili Helper itu apa sih?</li>
      <li class="faq-item" data-text="Secara teknis, kamu membuat pesanan lewat aplikasi, kurir akan menindaklanjuti, dan kamu bisa memantau statusnya secara real-time.">2. Gimana teknisnya?</li>
      <li class="faq-item" data-text="Tarif layanan standard adalah Rp 5.000, tanpa biaya tambahan.">3. Berapa tarif atau pembayaran nya?</li>
      <li class="faq-item" data-text="Pembayaran dilakukan tunai saat layanan selesai, via e-wallet, atau transfer bank sesuai preferensi.">4. Bagaimana proses pembayarannya?</li>
    </ul>
  </div>
</div>
<div class="faq-overlay" id="faqOverlay"></div>
<div class="faq-popup" id="faqPopup">
  <h4 id="faqTitle">Judul FAQ</h4>
  <p id="faqText">Penjelasan FAQ</p>
  <button class="close-btn" onclick="closeFaq()">Tutup</button>
</div>
<!-- ===== BOTTOM NAVIGATION ===== -->
<div class="bottom-nav">

  <div class="nav-item" onclick="location.href='index.html'">
    <svg viewBox="0 0 24 24">
      <path d="M3 12l9-9 9 9v9a1 1 0 0 1-1 1h-5v-6h-6v6H4a1 1 0 0 1-1-1z"/>
    </svg>
    <div>Home</div>
  </div>

  <div class="nav-item" onclick="location.href='helper.html'">
    <svg viewBox="0 0 24 24">
      <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm1 15h-2v-2h2zm0-4h-2V7h2z"/>
    </svg>
    <div>Pesan</div>
  </div>

  <div class="nav-item active" onclick="location.href='pesanan.html'">
    <svg viewBox="0 0 24 24">
      <path d="M4 4h16v2H4zm0 6h16v2H4zm0 6h16v2H4z"/>
    </svg>
    <div>Riwayat</div>
  </div>

</div>
<!-- POPUP KONFIRMASI PESANAN -->
<div id="confirmOverlay"></div>

<div id="confirmBox">
  <h3>Konfirmasi Pesanan</h3>
  <p>Yakin ingin mengirim pesanan ini?</p>

  <div class="confirm-actions">
    <button onclick="closeConfirm()" class="btn-cancel">Batal</button>
    <button onclick="confirmSendPesanan()" class="btn-confirm">Kirim</button>
  </div>
</div>
<!-- POPUP JAM TUTUP -->
<div id="closedOverlay"></div>
<div id="closedPopup">
  <img src="helper.png" alt="Helper" style="width:120px; display:block; margin:0 auto 16px;">
  <h3 style="text-align:center; color:#0f172a;">Maaf kami sudah tutup, buka lagi jam 9 pagi.</h3>
  <button id="closedBtn" style="margin-top:16px; padding:10px 16px; border:none; border-radius:12px; background:var(--primary); color:#fff; font-weight:700; cursor:pointer;">Oke</button>
</div>
<script>
/* THEME SYNC */
const THEME_KEY="app-theme";
const savedTheme=localStorage.getItem(THEME_KEY);
document.body.classList.add(savedTheme?`theme-${savedTheme}`:"theme-light");

/* FIREBASE INIT */
firebase.initializeApp({
  apiKey:"AIzaSyCl13_a4x-BQnWNUjf9JOQX1DKc-HxLBys",
  authDomain:"klien-39696.firebaseapp.com",
  projectId:"klien-39696"
});
const db=firebase.firestore();

let currentUser=null;
let userJenis=null;

/* AUTH */
firebase.auth().onAuthStateChanged(async user=>{
  if(!user) return location.href="login.html";
  currentUser = user;

  let doc = await db.collection("members").doc(user.uid).get();
  if(doc.exists){
    userJenis = "members";
  } else {
    doc = await db.collection("agens").doc(user.uid).get();
    if(doc.exists) userJenis = "agens";
  }

  if(!doc.exists){
    alert("Data user tidak ditemukan");
    return;
  }

  const d = doc.data();
  document.getElementById("nama").innerText = d.namaLengkap || "";
  document.getElementById("whatsapp").innerText = d.whatsapp || "";
  document.getElementById("alamat").innerText = d.alamat || "";
});

/* DROPDOWN LOGIC */
const jenisLayananBtn = document.getElementById("jenisLayananBtn");
const selectedOption = document.getElementById("selectedOption");
const customOptions = document.getElementById("customOptions");
const dynamicDiv = document.getElementById("dynamicInput");

jenisLayananBtn.addEventListener("click", e=>{
  e.stopPropagation();
  customOptions.style.display = "flex";
  customOptions.classList.add("show");
});

document.querySelectorAll(".custom-option").forEach(option=>{
  option.addEventListener("click", e=>{
    e.stopPropagation();
    selectedOption.innerText = option.innerText;
    selectedOption.dataset.value = option.dataset.value;
    customOptions.style.display = "none";
    customOptions.classList.remove("show");
    loadDynamicInput(option.dataset.value);
  });
});

document.addEventListener("click", ()=>{ customOptions.style.display = "none"; });

function loadDynamicInput(val){
  dynamicDiv.innerHTML="";
  if(val==="Titip Belanja"){
    dynamicDiv.innerHTML='<label>Belanja titipan *</label><textarea id="keterangan" rows="2" placeholder="Contoh: 3 roti, 2 air mineral"></textarea>';
  } else if(val==="Titip Makanan"){
    dynamicDiv.innerHTML='<label>Makanan titipan *</label><textarea id="keterangan" rows="2" placeholder="Contoh: 2 nasi goreng, 1 ayam bakar"></textarea>';
  } else if(val==="Antar Barang"){
    dynamicDiv.innerHTML='<label>Barang & tujuan *</label><textarea id="keterangan" rows="2" placeholder="Contoh: Antarkan sepatu ke rumah teman saya"></textarea>';
  } else if(val==="Lainnya"){
    dynamicDiv.innerHTML='<label>Jelaskan layanan lainnya *</label><textarea id="keterangan" rows="2" placeholder="Tulis manual layanan yang diinginkan"></textarea>';
  }
}

/* SUBMIT PESANAN */
async function submitPesanan() {
  const jenisLayananVal = selectedOption.dataset.value.trim();
  const keterangan = document.getElementById("keterangan")?.value.trim() || "";
  const catatanVal = document.getElementById("catatan").value.trim();

  if(!jenisLayananVal || !keterangan){
    showToast("Layanan & keterangan wajib diisi!");
    return;
  }

  try {
    // Ambil data user dari Firestore
    const docRef = await db.collection(userJenis).doc(currentUser.uid).get();
    if(!docRef.exists){
      showToast("Data user tidak ditemukan!");
      return;
    }
    const userData = docRef.data();

    const dataPesanan = {
      uid: currentUser.uid,
      nama: userData.namaLengkap || "",
      whatsapp: userData.whatsapp || "",
      alamat: userData.alamat || "",
      jenisLayanan: jenisLayananVal,
      keterangan: keterangan,
      catatan: catatanVal || ""
    };

    // --- 1. Kirim ke Firestore ---
    await db.collection("pesananFamiliHelper").add({
      ...dataPesanan,
      status: "diproses",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // --- 2. Kirim ke EmailJS ---
    emailjs.send("service_gp80ote","template_b3xri9i", dataPesanan)
      .then(res=>{
        console.log("Email terkirim!", res);
        showToast("Pesanan berhasil dikirim! ðŸš€");
      }, err=>{
        console.error("Email gagal dikirim!", err);
        showToast("Pesanan terkirim tapi email gagal!");
      });

    // Reset form
    selectedOption.innerText = "-- Pilih Layanan --";
    selectedOption.dataset.value = "";
    dynamicDiv.innerHTML = "";
    document.getElementById("catatan").value = "";

    setTimeout(()=>location.href="pesanan.html", 1500);

  } catch(err){
    console.error(err);
    showToast("Gagal mengirim pesanan, coba lagi!");
  }
}

  const faqItems = document.querySelectorAll('.faq-item');
  const faqPopup = document.getElementById('faqPopup');
  const faqOverlay = document.getElementById('faqOverlay');
  const faqTitle = document.getElementById('faqTitle');
  const faqText = document.getElementById('faqText');
  
  faqItems.forEach((item, index)=>{
    item.addEventListener('click', ()=>{
      faqTitle.innerText = item.innerText;
      faqText.innerText = item.dataset.text;
      faqPopup.style.display = 'block';
      faqOverlay.style.display = 'block';
    });
  });
  
  function closeFaq(){
    faqPopup.style.display = 'none';
    faqOverlay.style.display = 'none';
  }
  
  // klik overlay juga menutup popup
  faqOverlay.addEventListener('click', closeFaq);
  const page = location.pathname.split("/").pop();
  document.querySelectorAll(".nav-item").forEach(nav=>{
    nav.classList.remove("active");
  });
  
  if(page=="index.html") document.querySelectorAll(".nav-item")[0].classList.add("active");
  if(page=="helper.html") document.querySelectorAll(".nav-item")[1].classList.add("active");
  if(page=="pesanan.html") document.querySelectorAll(".nav-item")[2].classList.add("active");
/* TOAST */
  function showToast(message,duration=2000){
  let toast=document.createElement('div');
  toast.className='toast';
  toast.innerText=message;
  document.body.appendChild(toast);
  setTimeout(()=>toast.classList.add('show'),100);
  setTimeout(()=>{
    toast.classList.remove('show');
    setTimeout(()=>document.body.removeChild(toast),300);
  },duration);
}
/* KONFIRMASI PESANAN */
const confirmOverlay = document.getElementById("confirmOverlay");
const confirmBox = document.getElementById("confirmBox");

function openConfirm(){
  confirmOverlay.style.display="block";
  confirmBox.style.display="block";
}

function closeConfirm(){
  confirmOverlay.style.display="none";
  confirmBox.style.display="none";
}

// Klik luar popup = batal
confirmOverlay.addEventListener("click", closeConfirm);

// Jika user klik KIRIM
function confirmSendPesanan(){
  closeConfirm();
  submitPesanan(); // <-- FUNGSI ASLI KAMU DIPANGGIL
}
const overlay = document.getElementById("closedOverlay");
const popup = document.getElementById("closedPopup");
const btn = document.getElementById("closedBtn");

let popupTimeout = null;

function showClosedPopup() {
  const now = new Date();
  const hours = now.getHours();

  // Jam tutup: 18:00 - 09:00
  const isClosed = hours >= 18 || hours < 9;

  if(!isClosed){
    // Jika jam sudah 09:00 - popup hilang
    overlay.style.display = "none";
    popup.style.display = "none";
    if(popupTimeout) clearTimeout(popupTimeout);
    return;
  }

  overlay.style.display = "block";
  popup.style.display = "block";

  // Set timer untuk munculkan lagi setiap 3 detik setelah ditutup
  if(popupTimeout) clearTimeout(popupTimeout);
  popupTimeout = setTimeout(showClosedPopup, 1000);
}

// Tombol Oke
// Tombol Oke
btn.addEventListener("click", ()=>{
  overlay.style.display = "none";
  popup.style.display = "none";
  location.reload(); // <-- Tambahkan ini untuk refresh halaman
  // Setelah 3 detik muncul lagi otomatis
  if(popupTimeout) clearTimeout(popupTimeout);
  popupTimeout = setTimeout(showClosedPopup, 3000);
});

// Jalankan saat load & setiap 1 menit cek jam
showClosedPopup();
setInterval(showClosedPopup, 60000);
</script>

</body>
</html>