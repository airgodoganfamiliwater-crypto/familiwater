<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="icon" href="ikon-512.png">
<title>Input Agen</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* ===============================
     GLOBAL RESET
  =============================== */
  *{
    box-sizing:border-box;
    font-family:'Nunito',sans-serif;
    user-select:none;
    -webkit-user-select:none;
    outline:none;
  }
  
  body{
    margin:0;
    min-height:100vh;
    background:var(--bg);
    color:var(--text);
    transition:background .3s ease,color .3s ease;
    -webkit-tap-highlight-color:transparent;
  }
  
  /* ===============================
     ROOT THEME (SUDAH FIX)
  =============================== */
  :root{
    --primary:#2563eb;
    --primary-soft:#dbeafe;
    --bg:#f8fafc;
    --card:#ffffff;
    --text:#0f172a;
    --muted:#64748b;
    --danger:#ef4444;
    --border:#e5e7eb;
    --radius:18px;
    --blur:10px;
    --glow:none;
  }
  
  body.theme-dark{
    --bg:#0b1220;
    --card:#0f172a;
    --text:#e5e7eb;
    --muted:#94a3b8;
    --primary:#60a5fa;
    --primary-soft:#1e293b;
    --border:#1e293b;
  }
  
  body.theme-future{
    --bg:radial-gradient(circle at top,#0b0f1a,#020617);
    --card:rgba(15,23,42,.65);
    --text:#e0f2fe;
    --muted:#7dd3fc;
    --primary:#22d3ee;
    --primary-soft:rgba(34,211,238,.12);
    --danger:#fb7185;
    --border:rgba(34,211,238,.35);
    --glow:
      0 0 12px rgba(34,211,238,.35),
      0 0 26px rgba(34,211,238,.2);
  }
  
  /* ===============================
     HEADER
  =============================== */
  .header{
    height:220px;
    background:var(--primary);
    border-radius:0 0 32px 32px;
    border-bottom-left-radius:36px;
    border-bottom-right-radius:36px;
  }
  body.theme-dark .header{
    background:#020617;
  }
  
  body.theme-future .header{
    background:
      radial-gradient(circle at top,rgba(34,211,238,.35),transparent 60%),
      linear-gradient(135deg,#020617,#020617);
    box-shadow:var(--glow);
  }
  /* ================= LAYOUT ================= */
  .container{
    padding:0 16px 32px;
    margin-top:-150px;
  }

  .card {
    position: relative; /* Tambahkan ini */
    background: var(--card);
    border-radius: var(--radius);
    padding: 18px;
    margin-bottom: 18px;
    box-shadow: 0 12px 28px rgba(0,0,0,.08), var(--glow);
    border: 1px solid var(--border);
    transition:
      transform .25s ease,
      box-shadow .25s ease,
      background .25s ease;
    z-index: 5;
  }
  .card h1, h2{
    color: var(--primary);
  }
  .card-info-btn {
    position: absolute; /* RELATIF KE CARD */
    top: 12px;
    right: 12px;
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    transition: transform .2s ease, filter .2s ease;
  }
  
  .card-info-btn:hover {
    transform: scale(1.1);
    filter: brightness(1.1);
  }
  #infoPopup .popup-overlay {
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: rgba(0,0,0,0.4);
    z-index: 50;
  }
  
  #infoPopup .popup-card {
    position: fixed;
    top:50%;
    left:50%;
    transform: translate(-50%,-50%);
    background: var(--card);
    padding: 24px;
    border-radius: 16px;
    max-width: 320px;
    width: 90%;
    z-index: 60;
    text-align: center;
  }
  #infoPopup h2 {
    margin-bottom: 12px;
  }
  #infoPopup p {
    text-align: left;
    margin-bottom: 18px;
  }
  #infoPopup button {
    width: 80px;
    margin: 0 auto;
  }
  .inputGroup{
    margin-bottom:12px;
  }
  #infoPopup {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  
  .popup-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(2px);
  }
  
  .popup-card {
    position: relative;
    background: var(--card);
    color: var(--text);
    border-radius: var(--radius);
    padding: 24px;
    width: 90%;
    max-width: 400px;
    z-index: 10;
    box-shadow: 0 12px 28px rgba(0,0,0,0.15);
  }
  
  .popup-card h2 {
    margin-bottom: 16px;
    color: var(--primary);
  }
  
  .popup-card p {
    text-align: left;
    margin-bottom: 12px;
    line-height: 1.4;
  }
  
  .popup-card button {
    display: block;
    margin: 0 auto;
    padding: 10px 20px;
    background: var(--primary);
    color: #fff;
    border-radius: 12px;
    border: none;
    cursor: pointer;
  }
  
  .popup-card button:hover {
    filter: brightness(1.1);
  }
  /* CUSTOM SELECT */
  .custom-select{
    position:relative;
    width:100%;
  }
  
  .select-trigger{
    width:100%;
    padding:10px;
    border-radius:10px;
    border:1px solid var(--border);
    background:var(--card);
    color:var(--text);
    display:flex;
    justify-content:space-between;
    align-items:center;
    cursor:pointer;
  }
  
  .select-arrow{
    font-size:14px;
    opacity:.7;
  }
  
  .select-options{
    position:absolute;
    top:110%;
    left:0;
    width:100%;
    max-height:220px;
    overflow:auto;
    border-radius:12px;
    border:1px solid var(--border);
    background:var(--card);   /* ganti jadi var(--card) biar sinkron tema */
    box-shadow:0 14px 28px rgba(0,0,0,.15), var(--glow);
    opacity:0;
    pointer-events:none;
    transform: translateY(-10px);
    transition: opacity .15s ease, transform .15s ease;
    z-index:999;
  }
  /* ===== ANIMASI DROPDOWN ===== */
  @keyframes dropdownIn {
    0%{
      opacity: 0;
      transform: translateY(-10px) scale(.98);
    }
    100%{
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  body.theme-dark .select-options{
    background: #535260f6;
    border-color:#1e293b;
  }
  
  body.theme-future .select-options{
    background: #535260e7;
    border-color: rgba(34,211,238,.35);
  }
  .select-options.show{
    opacity:1;
    pointer-events:auto;
    transform: translateY(0);
  }
  
  .select-options .option{
    padding:10px;
    cursor:pointer;
    border-bottom:1px solid var(--border);
  }
  
  .select-options .option:hover{
    background: color-mix(in srgb, var(--primary) 18%, transparent);
  }
  
  .select-options .option:last-child{
    border-bottom:none;
  }
  label{
    display:block;
    font-size:13px;
    color:#6b7280;
    margin-bottom:6px;
  }
  input{
    width:100%;
    padding:10px;
    border:1px solid var(--border);
    border-radius:10px;
    outline:none;
  }
  button{
    width:100%;
    padding:12px;
    border:none;
    border-radius:12px;
    background:#0041cd;
    color:#fff;
    font-weight:700;
    cursor:pointer;
  }
  .loading{
    text-align:center;
    color:#6b7280;
    margin-top:30px;
  }
  .error{
    color:#dc2626;
    background:#fee2e2;
    padding:12px;
    border-radius:12px;
  }
  .success{
    color:#166534;
    background:#dcfce7;
    padding:12px;
    border-radius:12px;
  }
    /* ===============================
     BOTTOM NAVBAR
  ============================== */
  .navbar{
    position:fixed;
    bottom:14px;
    left:14px;
    right:14px;
    height:70px;
    background:var(--card);
    border-radius:24px;
    border:1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 12px;
    box-shadow:
      0 14px 40px rgba(0,0,0,.25),
      var(--glow);
    backdrop-filter:blur(var(--blur));
    z-index:999;
  }

  /* ITEM */
  .nav-item{
    flex:1;
    text-align:center;
    text-decoration:none;
    color:var(--muted);
    font-size:11px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    transition:.25s ease;
  }

  .nav-item svg{
    width:22px;
    height:22px;
    fill:currentColor;
  }

  /* ACTIVE */
  .nav-item.active{
    color:var(--primary);
  }

  .nav-item.active svg{
    filter:drop-shadow(0 0 6px rgba(0,0,0,.2));
  }

  /* WHATSAPP SPECIAL BUTTON */
  .nav-wa{
    width:64px;
    height:64px;
    margin-top:-34px;
    background:linear-gradient(135deg,#22c55e,#16a34a);
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:
      0 14px 40px rgba(34,197,94,.6),
      var(--glow);
    border:4px solid var(--card);
  }

  .nav-wa img{
    width:34px;
    height:34px;
    border-radius:50%;
  }

  /* ===============================
     NAVBAR PROFILE AVATAR
  ================================ */
  .nav-avatar{
    width:26px;
    height:26px;
    border-radius:50%;
    background:#e5e7eb;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    border:2px solid var(--card);
  }

  .nav-avatar img{
    width: 38px;
    height: 38px;
    border-radius: 999px;
    object-fit: cover;
    border: 2px solid var(--primary);
  }

  .nav-avatar-icon{
    width:18px;
    height:18px;
    fill:currentColor;
  }

  /* ACTIVE STATE */
  .nav-item.active .nav-avatar{
    box-shadow:
      0 0 0 2px var(--primary),
      var(--glow);
  }

  /* ===============================
     NAVBAR AUTO HIDE ON SCROLL
  ================================ */
  .navbar{
    transition:
      transform .35s cubic-bezier(.4,0,.2,1),
      opacity .25s ease;
  }

  /* HIDDEN STATE */
  .navbar.hide{
    transform: translateY(120%);
    opacity: 0;
  }

  /* FUTURISTIC BOOST */
  body.theme-future .nav-wa{
    box-shadow:
      0 0 18px rgba(34,197,94,.8),
      0 0 40px rgba(34,197,94,.6);
  }
    /* ===============================
     GLOBAL BUTTON PRESS EFFECT
     (CLICK / TAP TIMBUL LALU BALIK)
  =============================== */
  
  /* TARGET SEMUA ELEMEN INTERAKTIF */
  button,
  .nav-item,
  .nav-wa,
  .nav-avatar,
  a{
    transition:
      transform .15s cubic-bezier(.4,0,.2,1),
      box-shadow .15s ease,
      filter .15s ease;
  }
  
  /* DESKTOP HOVER (HALUS) */
  @media (hover:hover){
    button:hover,
    .nav-item:hover,
    .nav-wa:hover,
    .nav-avatar:hover{
      transform: translateY(-2px);
    }
  }
  
  /* SAAT DIKLIK / TAP */
  .active-touch,
  button:active,
  .nav-item:active,
  .nav-wa:active,
  .nav-avatar:active{
    transform: translateY(-3px) scale(1.02);
    box-shadow:
      0 8px 18px rgba(0,0,0,.25),
      var(--glow);
    filter: brightness(1.05);
  }
  /* ===== Container history ===== */
  .hist {
    margin-top: 16px;
    max-height: 400px;       /* tinggi maksimum scrollable */
    overflow-y: auto;        /* scroll vertikal */
    padding: 8px;
    border-radius: var(--radius);
    background: var(--card);
    box-shadow: 0 2px 8px rgba(0,0,0,.05), var(--glow);
  }
  
  /* ===== Setiap item riwayat ===== */
  .history-items > div {
    padding: 12px 16px;
    margin-bottom: 8px;
    border-radius: var(--radius);
    background: var(--card);
    border: 1px solid var(--border);
    transition: transform 0.15s ease, box-shadow 0.15s ease, background .25s ease, color .25s ease;
  }
  
  /* Hover effect */
  .history-items > div:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08), var(--glow);
  }
  
  /* Tanggal */
  .history-items > div > div:first-child {
    font-weight: 700;
    color: var(--primary);       /* pakai warna primary */
    margin-bottom: 4px;
    font-size: 14px;
  }
  
  /* Nama member */
  .history-items > div > div:nth-child(2) {
    font-size: 13px;
    color: var(--text);
    margin-bottom: 2px;
  }
  
  /* Ambil */
  .history-items > div > div:nth-child(3) {
    font-size: 13px;
    color: var(--muted);
  }
  
  /* Notifikasi kosong / error */
  .history-items .success, .history-items .error {
    text-align: center;
    padding: 12px;
    color: #fff;
    border-radius: var(--radius);
  }
  
  .history-items .success {
    background-color: #4caf50; /* tetap hijau */
  }
  
  .history-items .error {
    background-color: #f44336; /* tetap merah */
  }
  
  /* Scrollbar (opsional biar enak diliat) */
  .hist::-webkit-scrollbar {
    width: 8px;
  }
  
  .hist::-webkit-scrollbar-track {
    background: var(--card);
    border-radius: var(--radius);
  }
  
  .hist::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: var(--radius);
  }
  
  .hist::-webkit-scrollbar-thumb:hover {
    background: var(--primary);
  }
</style>
</head>

<body>
<header class="header"></header>
<div class="container">
<div id="status" class="loading">Memuat...</div>

<div id="formCard" class="card" style="display:none;">
  <h1>Input Agen</h1>

  <!-- Tombol info pojok kanan atas -->
  <button class="card-info-btn" id="infoBtn">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="8" x2="12" y2="12"></line>
      <line x1="12" y1="16" x2="12" y2="16"></line>
    </svg>
  </button>

  <div class="inputGroup">
    <label for="nama">Nama Member</label>
    <div class="custom-select" id="namaSelect">
      <div class="select-trigger" id="namaTrigger">
        <span class="select-value">-- Pilih Member --</span>
        <span class="select-arrow">‚ñæ</span>
      </div>
      <div class="select-options" id="namaOptions"></div>
    </div>
  </div>

  <div class="inputGroup">
    <label for="ambil">Ambil</label>
    <input type="number" id="ambil" value="1" min="1" />
  </div>

  <button id="btnKirim">Kirim</button>
  <div id="msg"></div>
</div>

<!-- RIWAYAT -->
<div id="historyCard" class="card" style="display:none; margin-top:16px;">
  <h2>Riwayat Input</h2>

  <!-- 1. Search Nama -->
  <div class="inputGroup">
    <label for="searchNama">Search Nama</label>
    <input id="searchNama" type="text" placeholder="Cari nama..." />
  </div>

  <!-- 2. Filter Tanggal (1 tanggal) -->
  <div class="inputGroup">
    <label for="dateFilter">Filter Tanggal</label>
    <input id="dateFilter" type="date" />
  </div>

<div class="hist">
  <div id="historyList" class="history-items"></div>
  </div>
</div>
</div>

<!-- POPUP INFO AGENT -->
<div id="infoPopup" style="display:none;">
  <div class="popup-overlay"></div>
  <div class="popup-card">
    <h2 style="text-align:center;">üí° Sistem Poin Agen</h2>

    <p><strong>1. Dapat Poin Setiap Input Data:</strong><br>
       Setiap kali kamu input <strong>data member baru</strong>, kamu mendapat <strong>5 poin</strong>. 
       Event khusus bisa <strong>menambah poin lebih</strong>.</p>

    <p><strong>2. Validasi Admin:</strong><br>
       Admin akan <strong>mengecek data</strong> terlebih dahulu. 
       Poin akan ditambahkan <strong>hanya jika data valid</strong>.<br>
       <strong>Formula sederhana:</strong> Jika data valid ‚Üí Poin agen +5</p>

    <p><strong>3. Nama Member:</strong><br>
       Pilih nama member dari <strong>dropdown otomatis</strong> (ambil dari Firestore). 
       Pastikan memilih <strong>member yang sudah terdaftar</strong>.</p>

    <p><strong>4. Ajak Teman:</strong><br>
       Ajak teman <strong>daftar aplikasi</strong> dan <strong>beli galon</strong> untuk mendapatkan poin tambahan.</p>

    <p><strong>5. Tips Cepat:</strong><br>
       Semakin rajin input data yang valid, semakin cepat <strong>poinmu bertambah</strong>.</p>

    <button id="closePopup">OK</button>
  </div>
</div>
<nav class="navbar">
  <a href="index.html" class="nav-item" data-page="index.html">
    <svg width="36" viewBox="0 0 1664 1312" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M1408 768v480q0 26-19 45t-45 19H960V928H704v384H320q-26 0-45-19t-19-45V768q0-1 .5-3t.5-3l575-474l575 474q1 2 1 6zm223-69l-62 74q-8 9-21 11h-3q-13 0-21-7L832 200L140 777q-12 8-24 7q-13-2-21-11l-62-74q-8-10-7-23.5T37 654L756 55q32-26 76-26t76 26l244 204V64q0-14 9-23t23-9h192q14 0 23 9t9 23v408l219 182q10 8 11 21.5t-7 23.5z" fill="currentColor"/></svg>
    <span>Home</span>
  </a>

  <a href="game.html" class="nav-item" data-page="game.html">
    <svg width="36" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M15.9 5.5C15.3 4.5 14.2 4 13 4H7c-1.2 0-2.3.5-2.9 1.5c-2.3 3.5-2.8 8.8-1.2 9.9c1.6 1.1 5.2-3.7 7.1-3.7s5.4 4.8 7.1 3.7c1.6-1.1 1.1-6.4-1.2-9.9zM8 9H7v1H6V9H5V8h1V7h1v1h1v1zm5.4.5c0 .5-.4.9-.9.9s-.9-.4-.9-.9s.4-.9.9-.9s.9.4.9.9zm1.9-2c0 .5-.4.9-.9.9s-.9-.4-.9-.9s.4-.9.9-.9s.9.4.9.9z" fill="currentColor"/></svg>
    <span>Game</span>
  </a>

  <a href="https://wa.me/6285759995235?text=Ang%20pengen%20banyu" target="_blank" class="nav-wa">
    <img src="logofw.png" alt="WA">
  </a>

  <a href="riwayat.html" class="nav-item" data-page="riwayat.html">
    <svg width="36" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path class="uim-primary" d="M12 2a10.017 10.017 0 0 0-6.994 2.872V3a1 1 0 0 0-2 0v4.5a1 1 0 0 0 1 1h4.5a1 1 0 0 0 0-2H6.218A7.98 7.98 0 1 1 4 12a1 1 0 0 0-2 0A10 10 0 1 0 12 2z" fill="currentColor"/><path class="uim-primary" d="M14 13h-2a1 1 0 0 1-1-1V9a1 1 0 0 1 2 0v2h1a1 1 0 0 1 0 2z" fill="currentColor"/><path class="uim-tertiary" d="M12 4a8.008 8.008 0 0 0-5.782 2.5h2.288a1 1 0 0 1 0 2h-4.5a.99.99 0 0 1-.978-.889A9.922 9.922 0 0 0 2 12a1 1 0 0 1 2 0a8 8 0 1 0 8-8zm2 9h-2a1 1 0 0 1-1-1V9a1 1 0 0 1 2 0v2h1a1 1 0 0 1 0 2z" opacity=".5" fill="currentColor"/></svg>
    <span>Riwayat</span>
  </a>

  <a href="profil.html" class="nav-item nav-profile" data-page="profil.html">
    <div class="nav-avatar">
    <svg width="36" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M24 42c9.941 0 18-8.059 18-18S33.941 6 24 6S6 14.059 6 24s8.059 18 18 18zm0 2c11.046 0 20-8.954 20-20S35.046 4 24 4S4 12.954 4 24s8.954 20 20 20z" fill="currentColor"/><path d="M12 35.63c0-1.033.772-1.906 1.8-2.02c7.715-.854 12.72-.777 20.418.019a1.99 1.99 0 0 1 1.108 3.472c-9.085 7.919-14.277 7.81-22.686.008c-.41-.38-.64-.92-.64-1.478z" fill="currentColor"/><path fill-rule="evenodd" clip-rule="evenodd" d="M34.115 34.623c-7.637-.79-12.57-.864-20.206-.019c-.514.057-.909.496-.909 1.027c0 .286.119.557.32.745c4.168 3.866 7.326 5.613 10.413 5.624c3.098.011 6.426-1.722 10.936-5.652a.99.99 0 0 0-.554-1.724zM13.69 32.616c7.796-.863 12.874-.785 20.632.018a2.99 2.99 0 0 1 1.662 5.221c-4.575 3.988-8.385 6.16-12.257 6.145c-3.883-.014-7.525-2.223-11.766-6.158A3.018 3.018 0 0 1 11 35.63a3.028 3.028 0 0 1 2.69-3.015z" fill="currentColor"/><path d="M32 20a8 8 0 1 1-16 0a8 8 0 0 1 16 0z" fill="currentColor"/><path fill-rule="evenodd" clip-rule="evenodd" d="M24 26a6 6 0 1 0 0-12a6 6 0 0 0 0 12zm0 2a8 8 0 1 0 0-16a8 8 0 0 0 0 16z" fill="currentColor"/></g></svg>

    </div>
    <span>Profil</span>
  </a>
</nav>
<script>
// ===== THEME SYNC DARI PROFIL =====
const THEME_KEY = "app-theme";
const savedTheme = localStorage.getItem(THEME_KEY);

if(savedTheme){
  document.body.classList.add(`theme-${savedTheme}`);
} else {
  document.body.classList.add("theme-light");
}

/* =============================
   FIREBASE INIT
============================ */
firebase.initializeApp({
  apiKey: "AIzaSyCl13_a4x-BQnWNUjf9JOQX1DKc-HxLBys",
  authDomain: "klien-39696.firebaseapp.com",
  projectId: "klien-39696"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* =============================
   CACHE 24 JAM
============================ */
const CACHE_TTL = 24 * 60 * 60 * 1000; // 24 jam
const CACHE_KEY_HISTORY = "cache_riwayatagen";

function saveToCache(key, data){
  const payload = {
    ts: Date.now(),
    data: data
  };
  localStorage.setItem(key, JSON.stringify(payload));
}

function loadFromCache(key){
  const raw = localStorage.getItem(key);
  if(!raw) return null;

  try{
    const parsed = JSON.parse(raw);
    if(!parsed.ts || !parsed.data) return null;

    if(Date.now() - parsed.ts > CACHE_TTL){
      localStorage.removeItem(key);
      return null;
    }

    return parsed.data;
  } catch(e){
    localStorage.removeItem(key);
    return null;
  }
}

/* =============================
   AUTH CHECK (HANYA AGENS)
============================ */
auth.onAuthStateChanged(async user => {
  if(!user){
    document.getElementById("status").innerHTML =
      `<div class="error">‚ùå Belum login</div>`;
    return;
  }

  try {
    await loadAgen(user.uid);
  } catch(err){
    document.getElementById("status").innerHTML =
      `<div class="error">${err.message}</div>`;
  }
});

/* =============================
   LOAD AGENS DATA
============================ */
async function loadAgen(uid){
  const agenDoc = await db.collection("agens").doc(uid).get();
  if(!agenDoc.exists){
    throw new Error("Akses ditolak. Hanya agens yang boleh mengakses halaman ini.");
  }

  const agenData = agenDoc.data();
  const namaID = agenData.namaID;
  if(!namaID){
    throw new Error("Data agen tidak lengkap (namaID kosong).");
  }

  document.getElementById("status").style.display = "none";
  document.getElementById("formCard").style.display = "block";

  const namaTrigger = document.getElementById("namaTrigger");
  const namaOptions = document.getElementById("namaOptions");
  namaOptions.innerHTML = ""; // reset dulu

  // load dropdown member
  const snap = await db.collection("members")
  .where("agen", "==", namaID)
  .get();

  if(snap.empty){
    showMsg("Tidak ada member untuk agen ini.", "error");
    return;
  }

  snap.forEach(doc => {
    const data = doc.data();
    const option = document.createElement("div");
    option.classList.add("option");
    option.dataset.docid = doc.id;
    option.dataset.namaid = data.namaID;
    option.dataset.namalengkap = data.namaLengkap;
    option.innerText = data.namaLengkap || data.namaID;
    namaOptions.appendChild(option);
  });
  namaOptions.querySelectorAll(".option").forEach(opt=>{
    opt.addEventListener("click", ()=>{
      namaTrigger.querySelector(".select-value").innerText = opt.innerText;
      namaTrigger.dataset.docid = opt.dataset.docid;
      namaTrigger.dataset.namaid = opt.dataset.namaid;
      namaTrigger.dataset.namalengkap = opt.dataset.namalengkap;
      namaOptions.classList.remove("show");
    });
  });
  namaTrigger.addEventListener("click", ()=>{
    namaOptions.classList.toggle("show");
  });
  document.addEventListener("click", (e)=>{
    if(!document.getElementById("namaSelect").contains(e.target)){
      namaOptions.classList.remove("show");
    }
  });

  // load history
  await loadHistory(namaID);

  // kirim data
  const btn = document.getElementById("btnKirim");
  btn.replaceWith(btn.cloneNode(true));

  document.getElementById("btnKirim").addEventListener("click", async () => {
    const docId = namaTrigger.dataset.docid;

    if(!docId){
      return showMsg("Pilih member dulu.", "error");
    }

    const ambil = Number(document.getElementById("ambil").value);
    if(ambil < 1){
      return showMsg("Ambil minimal 1.", "error");
    }

    const namaIDmember = namaTrigger.dataset.namaid;
    const namaLengkap = namaTrigger.dataset.namalengkap;

    const payload = {
      nama: namaIDmember,
      namaLengkap: namaLengkap,
      ambil: ambil,
      status: namaID, // namaID agen
      tanggal: firebase.firestore.FieldValue.serverTimestamp()
    };

    // 1. simpan ke inputagen
    await db.collection("inputagen").add(payload);

    // 2. simpan juga ke riwayatagen
    await db.collection("riwayatagen").add(payload);

    showMsg("Data berhasil dikirim.", "success");

    namaTrigger.querySelector(".select-value").innerText = "-- Pilih Member --";
    namaTrigger.dataset.docid = "";
    namaTrigger.dataset.namaid = "";
    namaTrigger.dataset.namalengkap = "";
    document.getElementById("ambil").value = 1;

    // refresh history + update cache
    await loadHistory(namaID, { forceRefresh: true });
  });

  // AUTO FILTER (LIVE)
  let debounceTimer;
  document.getElementById("searchNama").addEventListener("input", () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=> applyFilter(namaID), 300);
  });

  document.getElementById("dateFilter").addEventListener("change", async () => {
    await applyFilter(namaID);
  });
}

async function applyFilter(namaID) {
  const nama = document.getElementById("searchNama").value.trim().toLowerCase();
  const date = document.getElementById("dateFilter").value;
  await loadHistory(namaID, { nama, date });
}

// ===== Helper untuk parse tanggal =====
function parseTanggal(tanggal) {
  if (!tanggal) return null;

  // Firebase Timestamp asli
  if (tanggal.toDate) return tanggal.toDate();

  // Data cache biasanya {seconds, nanoseconds}
  if (tanggal.seconds !== undefined) {
    return new Date(tanggal.seconds * 1000);
  }

  // Kalau masih string / Date
  return new Date(tanggal);
}

// ===== Load History Agen =====
async function loadHistory(namaID, filter = {}) {
  const historyCard = document.getElementById("historyCard");
  const historyList = document.getElementById("historyList");

  historyCard.style.display = "block";
  historyList.innerHTML = "Memuat riwayat...";

  try {
    let dataArr = null;

    // 1. Load dari cache jika ada dan belum expired
    if(!filter.forceRefresh){
      dataArr = loadFromCache(CACHE_KEY_HISTORY);
    }

    // 2. Kalau cache kosong, ambil dari Firestore
    if(!dataArr){
      const snap = await db.collection("riwayatagen")
        .where("status", "==", namaID)
        .orderBy("tanggal", "desc")
        .limit(50)
        .get();

      dataArr = [];
      snap.forEach(doc => {
        const data = doc.data();
        dataArr.push(data);
      });

      // Simpan ke cache
      saveToCache(CACHE_KEY_HISTORY, dataArr);
    }

    // ===== FILTER NAMA =====
    if (filter.nama) {
      dataArr = dataArr.filter(d =>
        (d.namaLengkap || "").toLowerCase().includes(filter.nama)
      );
    }

    // ===== FILTER TANGGAL (1 tanggal) =====
    if (filter.date) {
      const target = new Date(filter.date);
      target.setHours(0,0,0,0);

      const next = new Date(filter.date);
      next.setHours(23,59,59,999);

      dataArr = dataArr.filter(d => {
        const t = parseTanggal(d.tanggal);
        return t && t >= target && t <= next;
      });
    }

    if (dataArr.length === 0) {
      historyList.innerHTML = "<div class='success'>Belum ada riwayat.</div>";
      return;
    }

    // ===== Render HTML =====
    let html = "";
    dataArr.forEach(d => {
      const tanggalObj = parseTanggal(d.tanggal);
      const tanggal = tanggalObj ? formatTanggal(tanggalObj) : "-";

      html += `
        <div style="padding:10px; border-bottom:1px solid #eee;">
          <div style="font-weight:700;">${tanggal}</div>
          <div>Nama: ${d.namaLengkap || d.nama}</div>
          <div>Ambil: ${d.ambil}</div>
        </div>
      `;
    });

    historyList.innerHTML = html;

  } catch (err) {
    historyList.innerHTML = `<div class="error">Error: ${err.message}</div>`;
  }
}

// ===== Format Tanggal ke ID =====
function formatTanggal(date) {
  const fmt = new Intl.DateTimeFormat("id-ID", {
    weekday: "long",
    day: "numeric",
    month: "long"
  });
  const full = fmt.format(date);
  return full.replace(/ \d{4}$/, ""); // hapus tahun jika ingin
}

function showMsg(text, type){
  const msg = document.getElementById("msg");
  msg.innerHTML = `<div class="${type}">${text}</div>`;
}

//popup info
const infoBtn = document.getElementById('infoBtn');
const infoPopup = document.getElementById('infoPopup');
const closePopup = document.getElementById('closePopup');

infoBtn.addEventListener('click', () => {
  infoPopup.style.display = 'block';
});

closePopup.addEventListener('click', () => {
  infoPopup.style.display = 'none';
});

/* NAVBAR ACTIV */
const currentPage = location.pathname.split("/").pop();

document.querySelectorAll(".nav-item").forEach(item=>{
  if(item.dataset.page === currentPage){
    item.classList.add("active");
  }
});

/* NAVBAR SCROLL BEHAVIOR */
let lastScrollY = window.scrollY;
const navbar = document.querySelector(".navbar");

window.addEventListener("scroll", ()=>{
  const currentScroll = window.scrollY;

  if(currentScroll > lastScrollY && currentScroll > 80){
    navbar.classList.add("hide");
  } else {
    navbar.classList.remove("hide");
  }

  lastScrollY = currentScroll;
});

/* NAVBAR PROFILE PHOTO SYNC */
function loadNavbarAvatar(){
  const avatarNav = document.querySelector(".nav-avatar");
  if(!avatarNav) return;

  const foto = localStorage.getItem("fotoProfil") || "default.png";
  const finalFoto = (foto && foto !== "") ? foto : "default.png";

  avatarNav.innerHTML = `
    <img src="${finalFoto}" alt="Profil" onerror="this.src='default.png'">
  `;
}

loadNavbarAvatar();

/*EFEK TOUCH*/
document.querySelectorAll("button, .nav-item, .nav-wa, .nav-avatar").forEach(el => {
  el.addEventListener("touchstart", () => {
    el.classList.add("active-touch");
  });
  el.addEventListener("touchend", () => {
    el.classList.remove("active-touch");
  });
});
</script>

</body>
</html>